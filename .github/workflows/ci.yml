name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1.1

    - name: Build MedVision.Dicom (Debug x64)
      shell: cmd
      run: |
        echo Building MedVision.Dicom
        msbuild "MedVision.Dicom\MedVision.Dicom.vcxproj" /p:Configuration=Release /p:Platform=x64 /m

    - name: Build MedVision.Dicom.Tests (Release x64)
      shell: cmd
      run: |
        echo Building MedVision.Dicom.Tests
        msbuild "MedVision.Dicom.Tests\MedVision.Dicom.Tests.vcxproj" /p:Configuration=Release /p:Platform=x64 /m

    - name: Build MedVision.Imaging (Release x64)
      shell: cmd
      run: |
        echo Building MedVision.Imaging
        msbuild "MedVision.Imaging\MedVision.Imaging.vcxproj" /p:Configuration=Release /p:Platform=x64 /m

    - name: Run unit tests with vstest
      shell: cmd
      run: |
        echo Running unit tests
        set TEST_DLL=%GITHUB_WORKSPACE%\\bin\\x64\\Debug\\MedVision.Dicom.Tests.dll
        if exist "%TEST_DLL%" (
          echo Found %TEST_DLL%
          vstest.console.exe "%TEST_DLL%" /logger:trx
        ) else (
          echo Test DLL not found at %TEST_DLL% && dir %GITHUB_WORKSPACE%\\bin\\x64\\Debug\\ && exit 1
        )

    - name: Upload test results
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: |
          **/*.trx

    # TODO: Add build steps for MedVision.Imaging, MedVision.Rendering, MedVision.Viewer
    # Uncomment below when projects are created:
    #
    # - name: Build MedVision.Imaging (Debug x64)
    #   shell: cmd
    #   run: |
    #     echo Building MedVision.Imaging
    #     msbuild "MedVision.Imaging\MedVision.Imaging.vcxproj" /p:Configuration=Debug /p:Platform=x64 /m
    #
    # - name: Build MedVision.Rendering (Debug x64)
    #   shell: cmd
    #   run: |
    #     echo Building MedVision.Rendering
    #     msbuild "MedVision.Rendering\MedVision.Rendering.vcxproj" /p:Configuration=Debug /p:Platform=x64 /m
    #
    # - name: Build MedVision.Viewer (Debug x64)
    #   shell: cmd
    #   run: |
    #     echo Building MedVision.Viewer
    #     msbuild "MedVision.Viewer\MedVision.Viewer.vcxproj" /p:Configuration=Debug /p:Platform=x64 /m
    #
    # - name: Upload viewer executable
    #   uses: actions/upload-artifact@v4
    #   with:
    #     name: medvision-viewer
    #     path: |
    #       bin\x64\Debug\MedVision.Viewer.exe
